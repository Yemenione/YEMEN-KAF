generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Admin {
  id           Int           @id @default(autoincrement())
  email        String        @unique
  passwordHash String        @map("password_hash")
  name         String
  role         AdminRole     @default(EDITOR)
  avatar       String?
  firebaseUid  String?       @map("firebase_uid")
  lastLogin    DateTime?     @map("last_login")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  activityLogs ActivityLog[]

  @@map("admins")
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  adminId    Int      @map("admin_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  details    String?  @db.LongText
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")
  admin      Admin    @relation(fields: [adminId], references: [id])

  @@index([adminId], map: "activity_logs_admin_id_fkey")
  @@map("activity_logs")
}

model Customer {
  id              Int            @id @default(autoincrement())
  firstName       String?        @map("first_name")
  lastName        String?        @map("last_name")
  email           String         @unique
  passwordHash    String?        @map("password_hash")
  phone           String?
  avatar          String?
  firebaseUid     String?        @map("firebase_uid")
  createdAt       DateTime       @default(now()) @map("created_at")
  customerGroupId Int?           @map("customer_group_id")
  addresses       Address[]
  cartItems       CartItem[]
  customerGroup   CustomerGroup? @relation(fields: [customerGroupId], references: [id])
  orders          Order[]
  rmas            RMA[]
  tickets         Ticket[]
  wishlists       Wishlist[]
  reviews         Review[]

  @@index([customerGroupId], map: "customers_customer_group_id_fkey")
  @@map("customers")
}

model Address {
  id            Int      @id @default(autoincrement())
  customerId    Int      @map("customer_id")
  label         String?
  isDefault     Boolean  @default(false) @map("is_default")
  streetAddress String   @map("street_address") @db.Text
  city          String
  state         String?
  country       String
  postalCode    String?  @map("postal_code")
  phone         String?
  createdAt     DateTime @default(now()) @map("created_at")
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId], map: "addresses_customer_id_fkey")
  @@map("addresses")
}

model Category {
  id              Int        @id @default(autoincrement())
  name            String
  slug            String     @unique
  description     String?    @db.Text
  imageUrl        String?    @map("image_url")
  isActive        Boolean    @default(true) @map("is_active")
  displayOrder    Int        @default(0) @map("display_order")
  createdAt       DateTime   @default(now()) @map("created_at")
  metaDescription String?    @map("meta_description")
  metaTitle       String?    @map("meta_title")
  parentId        Int?       @map("parent_id")
  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  products        Product[]
  translations    Json?      @map("translations")

  @@index([parentId], map: "categories_parent_id_fkey")
  @@map("categories")
}

model Product {
  id              Int              @id @default(autoincrement())
  categoryId      Int?             @map("category_id")
  name            String
  slug            String           @unique
  sku             String?          @unique
  description     String?          @db.Text
  price           Decimal          @db.Decimal(10, 2)
  stockQuantity   Int              @default(0) @map("stock_quantity")
  weight          Decimal?         @default(0.500) @db.Decimal(10, 3)
  images          String?          @db.Text
  isActive        Boolean          @default(true) @map("is_active")
  isFeatured      Boolean          @default(false) @map("is_featured")
  brandId         Int?             @map("brand_id")
  supplierId      Int?             @map("supplier_id")
  width           Decimal?         @db.Decimal(10, 2)
  height          Decimal?         @db.Decimal(10, 2)
  depth           Decimal?         @db.Decimal(10, 2)
  reference       String?          @unique
  ean13           String?
  upc             String?
  ecotax          Decimal?         @default(0.000000) @db.Decimal(10, 6)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  // Financials
  costPrice       Decimal?         @map("cost_price") @db.Decimal(10, 2)
  taxRuleId       Int?             @map("tax_rule_id")
  taxRule         TaxRule?         @relation(fields: [taxRuleId], references: [id])
  metaDescription String?          @map("meta_description")
  metaTitle       String?          @map("meta_title")
  translations    Json?            @map("translations")
  relatedIds      String?          @map("related_ids") @db.Text
  hsCode          String?          @map("hs_code")
  originCountry   String?          @map("origin_country")
  compareAtPrice  Decimal?         @map("compare_at_price") @db.Decimal(10, 2)
  cartItems       CartItem[]
  orderItems      OrderItem[]
  variants        ProductVariant[]
  brand           Brand?           @relation(fields: [brandId], references: [id])
  category        Category?        @relation(fields: [categoryId], references: [id])
  supplier        Supplier?        @relation(fields: [supplierId], references: [id])
  stockMovements  StockMovement[]
  wishlists       Wishlist[]
  reviews         Review[]
  carriers        Carrier[]

  @@index([brandId], map: "products_brand_id_fkey")
  @@index([categoryId], map: "products_category_id_fkey")
  @@index([supplierId], map: "products_supplier_id_fkey")
  @@map("products")
}

model ProductVariant {
  id              Int                   @id @default(autoincrement())
  productId       Int                   @map("product_id")
  name            String
  sku             String                @unique
  price           Decimal               @db.Decimal(10, 2)
  stock           Int                   @default(0)
  weight          Decimal?              @db.Decimal(10, 3)
  isActive        Boolean               @default(true) @map("is_active")
  isbn            String?
  ean13           String?
  upc             String?
  images          String?               @db.Text
  compareAtPrice  Decimal?              @map("compare_at_price") @db.Decimal(10, 2)
  orderItems      OrderItem[]
  attributeValues ProductVariantValue[]
  product         Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockMovements  StockMovement[]

  @@index([productId], map: "product_variants_product_id_fkey")
  @@map("product_variants")
}

model Brand {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  logo        String?
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  products    Product[]

  @@map("brands")
}

model Supplier {
  id          Int       @id @default(autoincrement())
  name        String
  contactInfo String?   @map("contact_info") @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  products    Product[]

  @@map("suppliers")
}

model Media {
  id           Int      @id @default(autoincrement())
  filename     String
  originalName String   @map("original_name")
  path         String
  mimeType     String   @map("mime_type")
  size         Int
  altText      String?  @map("alt_text")
  folder       String?  @default("root")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("media_files")
}

model StoreConfig {
  key         String   @id
  value       String   @db.Text
  type        String   @default("text")
  group       String   @default("general")
  description String?
  isPublic    Boolean  @default(false)
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("store_config")
}

model Attribute {
  id         Int              @id @default(autoincrement())
  name       String
  publicName String?          @map("public_name")
  type       String           @default("select")
  translations Json?          @map("translations")
  values     AttributeValue[]

  @@map("attributes")
}

model AttributeValue {
  id            Int                   @id @default(autoincrement())
  attributeId   Int                   @map("attribute_id")
  name          String
  value         String?
  position      Int                   @default(0)
  translations  Json?                 @map("translations")
  attribute     Attribute             @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  variantValues ProductVariantValue[]

  @@index([attributeId], map: "attribute_values_attribute_id_fkey")
  @@map("attribute_values")
}

model ProductVariantValue {
  id               Int            @id @default(autoincrement())
  variantId        Int            @map("variant_id")
  attributeValueId Int            @map("attribute_value_id")
  attributeValue   AttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)
  variant          ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, attributeValueId])
  @@index([attributeValueId], map: "product_variant_values_attribute_value_id_fkey")
  @@map("product_variant_values")
}

model StockMovement {
  id          Int             @id @default(autoincrement())
  productId   Int             @map("product_id")
  variantId   Int?            @map("variant_id")
  quantity    Int
  reason      String
  referenceId String?         @map("reference_id")
  adminId     Int?            @map("admin_id")
  createdAt   DateTime        @default(now()) @map("created_at")
  product     Product         @relation(fields: [productId], references: [id])
  variant     ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([productId], map: "stock_movements_product_id_fkey")
  @@index([variantId], map: "stock_movements_variant_id_fkey")
  @@map("stock_movements")
}

model Wishlist {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  productId  Int      @map("product_id")
  createdAt  DateTime @default(now()) @map("created_at")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId])
  @@index([productId], map: "wishlists_product_id_fkey")
  @@map("wishlists")
}

model CartItem {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  productId  Int      @map("product_id")
  quantity   Int
  createdAt  DateTime @default(now()) @map("created_at")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])

  @@index([customerId], map: "cart_items_customer_id_fkey")
  @@index([productId], map: "cart_items_product_id_fkey")
  @@map("cart_items")
}

model Order {
  id              Int                  @id @default(autoincrement())
  customerId      Int?                 @map("customer_id")
  orderNumber     String               @unique @map("order_number")
  status          String               @default("Processing")
  totalAmount     Decimal              @map("total_amount") @db.Decimal(10, 2)
  subtotal        Decimal              @default(0.00) @db.Decimal(10, 2)
  taxTotal        Decimal              @default(0.00) @map("tax_total") @db.Decimal(10, 2)
  discountTotal   Decimal              @default(0.00) @map("discount_total") @db.Decimal(10, 2)
  shippingCost    Decimal              @default(0.00) @map("shipping_cost") @db.Decimal(10, 2)
  shippingMethod  String?              @map("shipping_method")
  shippingAddress String?              @map("shipping_address") @db.LongText
  billingAddress  String?              @map("billing_address") @db.LongText
  paymentMethod   String?              @map("payment_method")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  trackingNumber  String?              @map("tracking_number")
  carrierData     String?              @map("carrier_data") @db.LongText
  invoices        Invoice[]
  items           OrderItem[]
  statusHistory   OrderStatusHistory[]
  customer        Customer?            @relation(fields: [customerId], references: [id])
  rma             RMA?
  tickets         Ticket[]
  transactions    Transaction[]

  @@index([customerId], map: "orders_customer_id_fkey")
  @@map("orders")
}

model OrderItem {
  id           Int             @id @default(autoincrement())
  orderId      Int             @map("order_id")
  productId    Int?            @map("product_id")
  variantId    Int?            @map("variant_id")
  productSlug  String?         @map("product_slug")
  productTitle String?         @map("product_title")
  imageUrl     String?         @map("image_url") @db.Text
  sku          String?
  quantity     Int
  price        Decimal         @db.Decimal(10, 2)
  totalPrice   Decimal         @map("total_price") @db.Decimal(10, 2)
  order        Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product?        @relation(fields: [productId], references: [id])
  variant      ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId], map: "order_items_order_id_fkey")
  @@index([productId], map: "order_items_product_id_fkey")
  @@index([variantId], map: "order_items_variant_id_fkey")
  @@map("order_items")
}

model OrderStatusHistory {
  id        Int      @id @default(autoincrement())
  orderId   Int      @map("order_id")
  status    String
  note      String?  @db.Text
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId], map: "order_status_history_order_id_fkey")
  @@map("order_status_history")
}

model Invoice {
  id            Int           @id @default(autoincrement())
  orderId       Int           @map("order_id")
  invoiceNumber String        @unique @map("invoice_number")
  status        InvoiceStatus @default(DRAFT)
  pdfUrl        String?       @map("pdf_url")
  amount        Decimal       @db.Decimal(10, 2)
  issuedAt      DateTime      @default(now()) @map("issued_at")
  dueDate       DateTime?     @map("due_date")
  paidAt        DateTime?     @map("paid_at")
  order         Order         @relation(fields: [orderId], references: [id])

  @@index([orderId], map: "invoices_order_id_fkey")
  @@map("invoices")
}

model Transaction {
  id           Int               @id @default(autoincrement())
  orderId      Int               @map("order_id")
  amount       Decimal           @db.Decimal(10, 2)
  currency     String            @default("EUR")
  provider     PaymentProvider
  providerTxId String?           @map("provider_tx_id")
  status       TransactionStatus @default(PENDING)
  metadata     String?           @db.LongText
  createdAt    DateTime          @default(now()) @map("created_at")
  order        Order             @relation(fields: [orderId], references: [id])

  @@index([orderId], map: "transactions_order_id_fkey")
  @@map("transactions")
}

model CustomerGroup {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  discountPct Decimal    @default(0.00) @map("discount_pct") @db.Decimal(5, 2)
  color       String?
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  customers   Customer[]

  @@map("customer_groups")
}

model Ticket {
  id         Int             @id @default(autoincrement())
  customerId Int             @map("customer_id")
  orderId    Int?            @map("order_id")
  subject    String
  status     String          @default("Open")
  priority   String          @default("Normal")
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")
  messages   TicketMessage[]
  customer   Customer        @relation(fields: [customerId], references: [id])
  order      Order?          @relation(fields: [orderId], references: [id])

  @@index([customerId], map: "tickets_customer_id_fkey")
  @@index([orderId], map: "tickets_order_id_fkey")
  @@map("tickets")
}

model TicketMessage {
  id         Int      @id @default(autoincrement())
  ticketId   Int      @map("ticket_id")
  senderType String
  senderId   Int
  message    String   @db.Text
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at")
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId], map: "ticket_messages_ticket_id_fkey")
  @@map("ticket_messages")
}

model RMA {
  id         Int      @id @default(autoincrement())
  orderId    Int      @unique @map("order_id")
  customerId Int      @map("customer_id")
  status     String   @default("Pending")
  reason     String
  resolution String
  adminNotes String?  @map("admin_notes") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  customer   Customer @relation(fields: [customerId], references: [id])
  order      Order    @relation(fields: [orderId], references: [id])

  @@index([customerId], map: "rmas_customer_id_fkey")
  @@map("rmas")
}

model Language {
  id        Int      @id @default(autoincrement())
  name      String
  isoCode   String   @unique @map("iso_code")
  locale    String
  flag      String?
  isRTL     Boolean  @default(false) @map("is_rtl")
  isActive  Boolean  @default(true) @map("is_active")
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("languages")
}

model Translation {
  id        Int      @id @default(autoincrement())
  group     String
  key       String
  language  String
  value     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([group, key, language])
  @@map("translations")
}

model Currency {
  id           Int      @id @default(autoincrement())
  name         String
  isoCode      String   @unique @map("iso_code")
  symbol       String
  exchangeRate Decimal  @default(1.000000) @map("exchange_rate") @db.Decimal(10, 6)
  isDefault    Boolean  @default(false) @map("is_default")
  isActive     Boolean  @default(true) @map("is_active")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("currencies")
}

model TaxRule {
  id        Int      @id @default(autoincrement())
  name      String
  rate      Decimal  @db.Decimal(10, 4)
  country   String
  priority  Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  products  Product[]

  @@map("tax_rules")
}

model CartRule {
  id               Int       @id @default(autoincrement())
  name             String
  description      String?   @db.Text
  code             String    @unique
  priority         Int       @default(1)
  isActive         Boolean   @default(true) @map("is_active")
  startsAt         DateTime? @map("starts_at")
  endsAt           DateTime? @map("ends_at")
  minAmount        Decimal   @default(0.00) @map("min_amount") @db.Decimal(10, 2)
  totalAvailable   Int       @default(1000) @map("total_available")
  totalPerUser     Int       @default(1) @map("total_per_user")
  freeShipping     Boolean   @default(false) @map("free_shipping")
  reductionPercent Decimal   @default(0.00) @map("reduction_percent") @db.Decimal(5, 2)
  reductionAmount  Decimal   @default(0.00) @map("reduction_amount") @db.Decimal(10, 2)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("cart_rules")
}

model Page {
  id              Int      @id @default(autoincrement())
  title           String
  slug            String   @unique
  content         String?  @db.LongText
  structured_content Json? @map("structured_content")
  metaTitle       String?  @map("meta_title")
  metaDescription String?  @map("meta_description")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("cms_pages")
}

model NewsletterSubscriber {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("newsletter_subscribers")
}

enum AdminRole {
  SUPER_ADMIN
  EDITOR
  SUPPORT
  FULFILLMENT
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  VOID
  OVERDUE
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  MANUAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Review {
  id         Int      @id @default(autoincrement())
  rating     Int      @default(5) // 1-5 stars
  comment    String?  @db.Text
  images     String?  @db.Text // JSON array of image URLs
  isVerified Boolean  @default(false) @map("is_verified") // If user ordered the product
  isActive   Boolean  @default(true) @map("is_active") // Admin moderation
  createdAt  DateTime @default(now()) @map("created_at")

  customerId Int      @map("customer_id")
  patient    Customer @relation(fields: [customerId], references: [id])

  productId Int     @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  @@index([customerId])
  @@index([productId])
  @@map("reviews")
}

model Carrier {
  id              Int            @id @default(autoincrement())
  name            String
  code            String?        @unique // e.g., "colissimo", "mondial_relay"
  logo            String?        @db.Text
  deliveryTime    String?        @map("delivery_time")
  description     String?        @db.Text
  trackingUrl     String?        @map("tracking_url")
  isActive        Boolean        @default(true) @map("is_active")
  isFree          Boolean        @default(false) @map("is_free")
  type            String         @default("pudo") // 'home' or 'pudo' (Pick Up Drop Off)
  maxWeight       Int            @default(30000) @map("max_weight") // in grams
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  rates           ShippingRate[]
  products        Product[]      // Relation to Product kept for backward compatibility if needed
  
  @@map("carriers")
}

model ShippingZone {
  id        Int            @id @default(autoincrement())
  name      String         // e.g., "France", "Europe Zone 1"
  countries String         @db.Text // JSON: ["FR", "MC"]
  isActive  Boolean        @default(true) @map("is_active")
  rates     ShippingRate[]

  @@map("shipping_zones")
}

model ShippingRate {
  id        Int          @id @default(autoincrement())
  carrierId Int          @map("carrier_id")
  zoneId    Int          @map("zone_id")
  minWeight Int          @map("min_weight") // in grams
  maxWeight Int          @map("max_weight") // in grams
  price     Decimal      @db.Decimal(10, 2)
  carrier   Carrier      @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  zone      ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([carrierId])
  @@index([zoneId])
  @@map("shipping_rates")
}
model BlogPost {
  id          Int            @id @default(autoincrement())
  title       String
  slug        String         @unique
  content     String         @db.LongText
  excerpt     String?        @db.Text
  image       String?        @db.Text
  category    String?        @default("General")
  author      String?        @default("Yem Kaf")
  status      BlogPostStatus @default(DRAFT)
  views       Int            @default(0)
  translations Json?          @map("translations")
  publishedAt DateTime?      @map("published_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  @@map("blog_posts")
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}
